# Malware Detecting and Removing Malware using VirusTotal integration 

Simulate a malware dropper (e.g., using curl or Invoke-WebRequest equivalent) on the Ubuntu machine and observe the behavior using Wazuh SIEM â€” including process creation, file drops, or network connections.

Wazuh uses the integrator module to connect to external APIs and alerting tools such as VirusTotal. In this use case, you use the Wazuh File Integrity Monitoring (FIM) module to monitor a directory for changes and the VirusTotal API to scan the files in the directory. Then, configure Wazuh to trigger an active response script and remove files that VirusTotal detects as malicious. We test this use case on Ubuntu and Windows endpoints.
You need a VirusTotal API key in this use case to authenticate Wazuh to the VirusTotal API.

**Configuration for the Ubuntu endpoint**

Configure your environment as follows to test the use case for the Ubuntu endpoint. These steps work for other Linux distributions as well.

**Ubuntu endpoint**

Perform the following steps to configure Wazuh to monitor near real-time changes in the /root directory of the Ubuntu endpoint. These steps also install the necessary packages and create the active response script that removes malicious files.

1. Search for the <syscheck> block in the Wazuh agent configuration file **/var/ossec/etc/ossec.conf**. Make sure that <disabled> is set to no. This enables the Wazuh FIM to monitor for directory changes.

2. Add an entry within the <syscheck> block to configure a directory to be monitored in near real-time. In this case, you are monitoring the /root directory:

        <directories realtime="yes">/root</directories>

3. Install jq, a utility that processes JSON input from the active response script.

        sudo apt update
        sudo apt -y install jq

4. Create the **/var/ossec/active-response/bin/remove-threat.sh** active response script to remove malicious files from the endpoint:

--------------------------------------------------------------------------------------------------------
      #!/bin/bash
      
      LOCAL=`dirname $0`;
      cd $LOCAL
      cd ../
      
      PWD=`pwd`
      
      read INPUT_JSON
      FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
      COMMAND=$(echo $INPUT_JSON | jq -r .command)
      LOG_FILE="${PWD}/../logs/active-responses.log"
      
      #------------------------ Analyze command -------------------------#
      if [ ${COMMAND} = "add" ]
      then
       #Send control message to execd
       printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys", "parameters":{"keys":[]}}\n'
      
       read RESPONSE
       COMMAND2=$(echo $RESPONSE | jq -r .command)
       if [ ${COMMAND2} != "continue" ]
       then
        echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Remove threat active response aborted" >> ${LOG_FILE}
        exit 0;
       fi
      fi
      
      #Removing file
      rm -f $FILENAME
      if [ $? -eq 0 ]; then
       echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
      else
       echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
      fi
      
      exit 0;

------------------------------------------------------------------------------------------------------
5. Change the **/var/ossec/active-response/bin/remove-threat.sh** file ownership, and permissions:


        sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
        sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh

6. Restart the Wazuh agent to apply the changes:

        sudo systemctl restart wazuh-agent

# Wazuh server

Perform the following steps on the Wazuh server to alert for changes in the endpoint directory and enable the VirusTotal integration. These steps also enable and trigger the active response script whenever a suspicious file is detected.

1. Add the following rules to the **/var/ossec/etc/rules/local_rules.xml** file on the Wazuh server. These rules alert about changes in the /root directory that are detected by FIM scans:

--------------------------------------------------------------------------------------------
    <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
        <!-- Rules for Linux systems -->
        <rule id="100200" level="7">
            <if_sid>550</if_sid>
            <field name="file">/root</field>
            <description>File modified in /root directory.</description>
        </rule>
        <rule id="100201" level="7">
            <if_sid>554</if_sid>
            <field name="file">/root</field>
            <description>File added to /root directory.</description>
        </rule>
    </group>

--------------------------------------------------------------------------------------------------------------------

2. Add the following configuration to the Wazuh server **/var/ossec/etc/ossec.conf** file to enable the Virustotal integration. Replace <YOUR_VIRUS_TOTAL_API_KEY> with your VirusTotal API key. This allows to trigger a VirusTotal query whenever any of the rules 100200 and 100201 are triggered:

------------------------------------------------------------------------------------------------
     <ossec_config>
      <integration>
        <name>virustotal</name>
        <api_key><YOUR_VIRUS_TOTAL_API_KEY></api_key> <!-- Replace with your VirusTotal API key -->
        <rule_id>100200,100201</rule_id>
        <alert_format>json</alert_format>
      </integration>
    </ossec_config>
 ------------------------------------------------------------------------------------------------     

  Note The free VirusTotal API rate limits requests to four per minute. If you have a premium VirusTotal API key, with a high frequency of queries allowed, you can add more rules besides these two. You can also configure Wazuh to monitor more directories.

3. Append the following blocks to the Wazuh server **/var/ossec/etc/ossec.conf** file. This enables Active Response and triggers the remove-threat.sh script when VirusTotal flags a file as malicious:


        <ossec_config>
          <command>
            <name>remove-threat</name>
            <executable>remove-threat.sh</executable>
            <timeout_allowed>no</timeout_allowed>
          </command>
        
          <active-response>
            <disabled>no</disabled>
            <command>remove-threat</command>
            <location>local</location>
            <rules_id>87105</rules_id>
          </active-response>
        </ossec_config>

4. Add the following rules to the Wazuh server **/var/ossec/etc/rules/local_rules.xml** file to alert about the Active Response results:


        <group name="virustotal,">
          <rule id="100092" level="12">
            <if_sid>657</if_sid>
            <match>Successfully removed threat</match>
            <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
          </rule>
        
          <rule id="100093" level="12">
            <if_sid>657</if_sid>
            <match>Error removing threat</match>
            <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
          </rule>
        </group>

5. Restart the Wazuh manager to apply the configuration changes:

        sudo systemctl restart wazuh-manager

**Attack emulation**

1. Download an EICAR test file to the **/root** directory on the Ubuntu endpoint:

       sudo curl -Lo /root/eicar.com https://secure.eicar.org/eicar.com && sudo ls -lah /root/eicar.com

**Visualize the alerts**

You can visualize the alert data in the Wazuh dashboard. To do this, go to the Threat Hunting module and add the filters in the search bar to query the alerts.

**Linux - rule.id: is one of 553,100092,87105,100201**


# Proof-Of-Concept 

![Malware-detection-Image](https://github.com/Gagancybersec01/SIEM-Internship-Phase-1/blob/e862c7662cff95634284fd0bbc5e04d6a9ec6d3f/Screenshots/Malware-deletion%20.png)
![Malware-deletion-Image](https://github.com/Gagancybersec01/SIEM-Internship-Phase-1/blob/e862c7662cff95634284fd0bbc5e04d6a9ec6d3f/Screenshots/Malware-detection.png)







